#!/usr/bin/env bash

# {{- if eq .chezmoi.os "linux" }}

echo "linuix script"

ZELLIJ_VERSION="${ZELLIJ_VERSION:-v0.43.1}"
KUBIE_VERSION="${KUBIE_VERSION:-v0.26.1}"
K9S_VERSION="${K9S_VERSION:-v0.50.18}"
HELMFILE_VERSION="${HELMFILE_VERSION:-1.3.0}"
K0SCTL_VERSION="${K0SCTL_VERSION:-v0.28.0}"

# install sheldon
if ! command -v sheldon &> /dev/null ; then
    echo "Installing sheldon"
    curl --proto '=https' -fLsS https://rossmacarthur.github.io/install/crate.sh \
        | bash -s -- --repo rossmacarthur/sheldon --to $HOME/.local/bin
fi

# install starship
if ! command -v starship &> /dev/null ; then
    echo "Installing starship"
    curl -sS https://starship.rs/install.sh | sh -s -- --bin-dir $HOME/.local/bin -y
fi

# install direnv
if ! command -v direnv &> /dev/null ; then
    echo "Installing direnv"
    export bin_path="$HOME/.local/bin"
    curl -sfL https://direnv.net/install.sh | bash
fi

# install eza
if ! command -v eza &> /dev/null ; then
    echo "Installing eza"
    curl -sfL https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz | tar xz
    chmod +x eza
    mv eza $HOME/.local/bin
fi

# install fzf
if ! command -v fzf &> /dev/null ; then
    echo "Installing fzf"
    curl -sfL https://github.com/junegunn/fzf/releases/download/v0.67.0/fzf-0.67.0-linux_amd64.tar.gz | tar xz
    chmod +x fzf
    mv fzf $HOME/.local/bin
fi

# install zellij
if ! command -v zellij &> /dev/null ; then
    echo "Installing zellij"
    curl -sfL https://github.com/zellij-org/zellij/releases/download/${ZELLIJ_VERSION}/zellij-x86_64-unknown-linux-musl.tar.gz | tar xz
    chmod +x zellij
    mv zellij $HOME/.local/bin
fi

# install hashicorp terraform, packer, vault
if ! command -v terraform &> /dev/null ; then
    echo "Installing Terraform, Packer, and Vault"
    # Install prerequisites
    apt-get install -y gnupg software-properties-common

    # Add HashiCorp GPG key and repository
    wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null

    # Source os-release to get the codename reliably
    . /etc/os-release
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com ${UBUNTU_CODENAME:-$(lsb_release -cs)} main" | tee /etc/apt/sources.list.d/hashicorp.list > /dev/null

    # Install Terraform, Packer, and Vault
    apt-get update
    apt-get install -y terraform packer vault
fi


if ! command -v kubectl &> /dev/null ; then
    echo "Installing kubectl"
    apt-get update
    # Install kubectl from official Kubernetes repository
    # Reference: https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-using-native-package-management
    # Install required dependencies for APT repository management
    apt-get install -y apt-transport-https ca-certificates curl gnupg
    # Set up Kubernetes APT repository
    mkdir -p -m 755 /etc/apt/keyrings
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.35/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.35/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
    chmod 644 /etc/apt/sources.list.d/kubernetes.list
    # Update package lists and install kubectl
    apt-get update
    apt-get install -y kubectl
fi

if ! command -v helm &> /dev/null ; then
    echo "Installing helm"
    # Install Helm - Kubernetes package manager
    # Reference: https://helm.sh/docs/intro/install/
    # Helm helps you manage Kubernetes applications with charts
    curl -fsSL https://packages.buildkite.com/helm-linux/helm-debian/gpgkey | gpg --dearmor | tee /usr/share/keyrings/helm.gpg > /dev/null
    echo "deb [signed-by=/usr/share/keyrings/helm.gpg] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main" | tee /etc/apt/sources.list.d/helm-stable-debian.list
    apt-get update
    apt-get install -y helm
fi

if ! command -v kubie &> /dev/null ; then
    echo "Installing kubie"
    # Install kubie - Kubernetes context and namespace switcher
    # Kubie provides easier context switching and isolated shell sessions per context
    echo "Installing kubie ${KUBIE_VERSION}..."
    curl -fsSL "https://github.com/sbstp/kubie/releases/download/${KUBIE_VERSION}/kubie-linux-amd64" -o /usr/local/bin/kubie
    chmod 0755 /usr/local/bin/kubie
fi

if ! command -v k9s &> /dev/null ; then
    echo "Installing k9s"
    # Install k9s - Terminal-based UI for Kubernetes clusters
    # k9s provides a powerful terminal UI for managing Kubernetes resources
    echo "Installing k9s ${K9S_VERSION}..."
    TMP_DIR=$(mktemp -d)
    curl -fsSL "https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_amd64.tar.gz" -o "${TMP_DIR}/k9s.tar.gz"
    tar -xzf "${TMP_DIR}/k9s.tar.gz" -C "${TMP_DIR}" k9s
    install -m 0755 "${TMP_DIR}/k9s" /usr/local/bin/k9s
    rm -rf "${TMP_DIR}"
fi

if ! command -v helmfile &> /dev/null ; then
    echo "Installing helmfile"
    # Install helmfile - Declarative Helm chart deployment tool
    # Helmfile allows you to define multiple Helm releases in a declarative manner
    echo "Installing helmfile v${HELMFILE_VERSION}..."
    TMP_DIR=$(mktemp -d)
    curl -fsSL "https://github.com/helmfile/helmfile/releases/download/v${HELMFILE_VERSION}/helmfile_${HELMFILE_VERSION}_linux_amd64.tar.gz" -o "${TMP_DIR}/helmfile.tar.gz"
    tar -xzf "${TMP_DIR}/helmfile.tar.gz" -C "${TMP_DIR}" helmfile
    install -m 0755 "${TMP_DIR}/helmfile" /usr/local/bin/helmfile
    rm -rf "${TMP_DIR}"
fi

if ! command -v k0sctl &> /dev/null ; then
# Install k0sctl - k0s cluster lifecycle management tool
    # k0sctl is used to bootstrap and manage k0s Kubernetes clusters
    echo "Installing k0sctl ${K0SCTL_VERSION}..."
    curl -fSL "https://github.com/k0sproject/k0sctl/releases/download/${K0SCTL_VERSION}/k0sctl-linux-amd64" -o /usr/local/bin/k0sctl
    chmod 0755 /usr/local/bin/k0sctl
fi

# {{- end }}
